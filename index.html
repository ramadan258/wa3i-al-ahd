<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ุงูููุญุฏูู โ ูุงุนู | ูุจููุฉ ุงูููุญุฏูู</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SEO -->
  <meta name="description" content="ุงูููุญุฏูู โ ูุงุนู. ูุจุงุฏุฑุฉ ููุซุจุงุชุ ูุฌุงูุฏุฉ ุงูููุณุ ูุชุฌุฏูุฏ ุงูุนูุฏ ูู ูุจููุฉ ุงูููุญุฏูู." />
  <meta name="keywords" content="ุงูููุญุฏูู, ูุงุนู, ูุจููุฉ ุงูููุญุฏูู, ุฑูุถุงู, ุงูุซุจุงุช, ูุฌุงูุฏุฉ ุงูููุณ" />

  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="today.css" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />

  <!-- Firebase (Firestore + Auth) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
      setPersistence,
      inMemoryPersistence,
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      deleteDoc,
      serverTimestamp,
      onSnapshot,
      getDocs,
      query,
      orderBy,
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYROgGM5ZOSBKNX1cYkJa3s395yf8HDVE",
      authDomain: "tribe-app-e3e9c.firebaseapp.com",
      projectId: "tribe-app-e3e9c",
      storageBucket: "tribe-app-e3e9c.firebasestorage.app",
      messagingSenderId: "1087669498056",
      appId: "1:1087669498056:web:f04aed42afb4af483eb5fd",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Expose minimal API to non-module scripts.
    window.FB = {
      auth,
      db,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
      setPersistence,
      inMemoryPersistence,
      collection,
      doc,
      setDoc,
      deleteDoc,
      serverTimestamp,
      onSnapshot,
      getDocs,
      query,
      orderBy,
    };
  </script>

</head>

<body>

<!-- ุจูุงุจุฉ ุงุฎุชูุงุฑ ุงููุณุชุฎุฏู -->
<div id="identityGate" class="identity-gate" role="dialog" aria-modal="true" aria-label="ุงุฎุชูุงุฑ ุงููุณุชุฎุฏู">
  <div class="identity-card">
    <h2 class="identity-title">ูู ุฃูุชุ</h2>
    <p class="identity-sub">ุงุฎุชุฑ ุตูุฑุชู ููุฏุฎูู ุฅูู ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ.</p>

    <div id="identityLast" class="identity-last is-hidden" aria-live="polite"></div>

    <div class="identity-search">
      <input id="identitySearch" class="text-input" type="text" inputmode="search" placeholder="ุงุจุญุซ ุจุงูุงุณู..." autocomplete="off" />
    </div>

    <div id="identityGrid" class="identity-grid" aria-label="ูุงุฆูุฉ ุงูุฃุนุถุงุก"></div>

    <div class="identity-divider">
      <span>ูู ุชุฌุฏ ุงุณููุ</span>
    </div>

    <div class="identity-guest">
      <input id="guestName" class="text-input" type="text" placeholder="ุงูุชุจ ุงุณูู (ุงุฎุชูุงุฑู)" autocomplete="name" />
      <button id="enterGuestBtn" class="identity-btn" type="button">ุฏุฎูู ูุถูู</button>
    </div>

    <div class="identity-note">ููููู ูุงุญููุง ุชุบููุฑ ุงููุณุชุฎุฏู ูู ุฃุนูู ุงูุตูุญุฉ.</div>
  </div>
</div>

</div>

<div id="appRoot" class="app-root is-hidden" aria-hidden="true">

  <!-- ุฑุฃุณ ุงูุตูุญุฉ -->
  <header>
    <h1>ุงูููุญุฏูู</h1>
    <p>ูุจููุฉ ูุงุนู โ ูุจููุฉ ุงูููุญุฏูู</p>
    <p class="ramadan-text">๐ ูู ุงูุขู ุญุชู ุฑูุถุงูโฆ ูุฎุชุงุฑ ุงูุซุจุงุช</p>

<div class="userbar">
  <span class="user-pill" id="currentUserPill">โ</span>
  <button class="identity-btn ghost" id="switchUserBtn" type="button">ุชุจุฏูู ุงููุณุชุฎุฏู</button>
</div>

  </header>

  <!-- ุดุฑูุท ุฑูุถุงูู -->
  <div class="ramadan-banner">
    ๐ ุนูุฏู ูุน ุงููู โ ูุนูู ุจุงูููุณ โ ุซุจุงุชู ุญุชู ุฑูุถุงู
  </div>

  <!-- ุดุฑูุท ุงูุชููู -->
  <nav>
    <a href="#today">ุฑุญูุฉ ุงูููู</a>
        <a href="#ahd">ุงูุนูุฏ</a>
<a href="#members">ุงูุฃุนุถุงุก</a>
    <a href="#countdown">ุงูุนุฏู ุงูุชูุงุฒูู</a>
    <a href="#about">ูุง ูู ูุงุฆูุฉ ุงูุนูุฏ</a>
    <a href="#values">ุงูููู</a>
  </nav>

  <!-- =====================
       ุฑุญูุฉ ุงูููู
  ===================== -->
  <section id="today">
    <h2>ุฑุญูุฉ ุงูููู</h2>

    <div class="today-layout">
      <aside class="today-side">
        <div class="panel">
          <div class="panel-title">ุชุงุฑูุฎ ุงูููู</div>
          <div class="panel-value" id="todayDate">โ</div>
        </div>

        <div class="panel">
          <div class="panel-title">ูุฑุงุกุฉ ุงููุฑุขู ุงูููููุฉ</div>
          <div class="panel-value" id="hizbNumber">โ</div>
          <div class="panel-sub" id="hizbHint">โ</div>
        </div>

        <div class="panel">
          <div class="panel-title">ุณูุชุฑูู ุงูุซุจุงุช</div>
          <div class="panel-value"><span id="streakCount">0</span> ๐ฅ</div>
          <div class="panel-sub">ูุฒูุฏ ุนูุฏ ุฅููุงู ุฌููุน ููุงู ุงูููู</div>
        </div>

        <div class="panel">
          <div class="panel-title">ูุณุจุฉ ุงูุฅูุฌุงุฒ ุงููููู</div>
          <div class="progress-head">
            <span class="pill" id="progressText">0%</span>
            <span class="muted" id="progressSub">ุงุจุฏุฃ ุจุฎุทูุฉ ูุงุญุฏุฉโฆ ุซู ุฃููู.</span>
          </div>

          <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-fill" id="progressFill" style="width:0%"></div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">ุชุญูู</div>
          <button class="btn ghost w-full" id="resetToday" type="button">ุชุตููุฑ ููุงู ุงูููู</button>
          <div class="panel-sub">ูุชู ุญูุธ ุชูุฏูู ุชููุงุฆููุง ุนูู ูุฐุง ุงูุฌูุงุฒ.</div>
        </div>
      </aside>

      <div class="today-main">
        <div class="tasks">
          <div class="task-card">
            <label class="task-line">
              <input type="checkbox" data-task="attendance" />
              <span class="task-title">ุชุณุฌูู ุญุถูุฑ โ๏ธ</span>
            </label>
            <div class="task-desc">ุงุจุฏุฃ ูููู ุจุชุฌุฏูุฏ ุงูููุฉ ูุงูุญุถูุฑ.</div>
          </div>

          <!-- ุฃุฐูุงุฑ ุงูุตุจุงุญ -->
          <div class="task-card">
            <label class="task-line">
              <input type="checkbox" data-task="morning_adhkar" />
              <span class="task-title">ุฃุฐูุงุฑ ุงูุตุจุงุญ โ๏ธ</span>
            </label>
            <div class="task-desc">
              <button type="button" class="azkar-open-btn" id="openMorningAzkar">
                ุนุฑุถ ุฃุฐูุงุฑ ุงูุตุจุงุญ ูุงููุฉ
              </button>
            </div>
          </div>

          <!-- ูุฑุงุกุฉ ุงููุฑุขู: 10 ุตูุญุงุช ููููุงู -->
          <div class="task-card">
            <label class="task-line">
              <input type="checkbox" data-task="quran_hizb" />
              <span class="task-title">ูุฑุงุกุฉ 10 ุตูุญุงุช ูู ุงููุฑุขู โ๏ธ</span>
            </label>

            <div class="task-desc">
              ุงูููู: <b id="hizbLabel">โ</b>
              <div style="margin-top:10px">
                <button type="button" class="azkar-open-btn" id="openQuranReading">
                  ุนุฑุถ ุตูุญุงุช ุงูููู
                </button>
              </div>
            </div>
          </div>

          <!-- ุฃุญุงุฏูุซ ูุจููุฉ -->
          <div class="task-card">
            <label class="task-line">
              <input type="checkbox" data-task="hadith" />
              <span class="task-title">ุฃุญุงุฏูุซ ูุจููุฉ ุงูููู โ๏ธ</span>
            </label>
            <div class="task-desc">
              <button type="button" class="azkar-open-btn" id="openHadithModal">ุนุฑุถ ุฃุญุงุฏูุซ ุงูููู (ูฅ ุฃุญุงุฏูุซ)</button>
            </div>
          </div>

          <!-- ููุงู ุงูุชุนุงูู -->
          <div class="task-card">
            <label class="task-line">
              <input type="checkbox" data-task="recovery_article" />
              <span class="task-title">ููุงู ุนู ุงูุชุนุงูู โ๏ธ</span>
            </label>
            <div class="task-desc">
              <a class="task-link" id="recoveryLink" target="_blank" rel="noopener">ูุชุญ ููุงู ุงูุชุนุงูู</a>
            </div>
          </div>

          <!-- ุงูุชููุณ -->
          <div class="task-card">
            <div class="task-top">
              <div class="task-top-title">ุนุงุฏุฉ ุงูุชูููุณ ุงูุนููู โ๏ธ</div>
              <span class="pill" id="breathStatus">ุบูุฑ ููุชูู</span>
            </div>

            <div class="breath-box">
              <div class="breath-left">
                <div class="breath-time" id="breathTime">01:00</div>
                <div class="breath-hint" id="breathHint">ุดููู 4 โข ุญุจุณ 2 โข ุฒููุฑ 6</div>
              </div>

              <div class="breath-actions">
                <button class="btn" id="breathStart" type="button">ุงุจุฏุฃ</button>
                <button class="btn ghost" id="breathReset" type="button">ุฅุนุงุฏุฉ</button>

                <label class="task-line compact">
                  <input type="checkbox" data-task="deep_breath" />
                  <span>ุชู โ๏ธ</span>
                </label>
              </div>
            </div>
          </div>

          <!-- ุงูุชุญุฏู -->
          <div class="task-card">
            <label class="task-line">
              <input type="checkbox" data-task="challenge" />
              <span class="task-title">ุชุญุฏูู ุงูููู โ๏ธ</span>
            </label>
            <div class="task-desc">
              <div class="challenge-box">
                <div class="challenge-title" id="challengeTitle">โ</div>
                <div class="challenge-sub" id="challengeSub">ุงุจุฏุฃ ุงูุขูโฆ ููู ูุฑุฉ ูุงุญุฏุฉ.</div>
              </div>
            </div>
          </div>

          <!-- ุฃุฐูุงุฑ ุงููุณุงุก -->
          <div class="task-card">
            <label class="task-line">
              <input type="checkbox" data-task="evening_adhkar" />
              <span class="task-title">ุฃุฐูุงุฑ ุงููุณุงุก โ๏ธ</span>
            </label>
            <div class="task-desc">
              <button type="button" class="azkar-open-btn" id="openEveningAzkar">
                ุนุฑุถ ุฃุฐูุงุฑ ุงููุณุงุก ูุงููุฉ
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- =====================
       ุงูุฃุนุถุงุก
  ===================== -->
  <section id="members">
    <h2>ุฃุนุถุงุก ุงููุจููุฉ</h2>

    <div class="slider-container">
      <div class="slider">
        <div class="slide-card">
          <img src="images/person12.jpg" alt="ุงููููุฑ ุงูู ุงููู" />
          <h3>ุงููููุฑ ุงูู ุงููู</h3>
        </div>

        <div class="slide-card">
          <img src="images/person1.jpg" alt="ุนุจุฏุงููู ุฌูููุฉ" />
          <h3>ุนุจุฏุงููู ุฌูููุฉ</h3>
        </div>

        <div class="slide-card">
          <img src="images/person2.jpg" alt="ุฃุญูุฏ ุนูุฑู" />
          <h3>ุฃุญูุฏ ุนูุฑู</h3>
        </div>

        <div class="slide-card">
          <img src="images/person3.jpg" alt="ุทููุญ" />
          <h3>ุทููุญ</h3>
        </div>

        <div class="slide-card">
          <img src="images/person4.jpg" alt="ุงูุฑูุณ" />
          <h3>ุงูุฑูุณ</h3>
        </div>

        <div class="slide-card">
          <img src="images/person5.jpg" alt="ููุณู ุตูุงุญ" />
          <h3>ููุณู ุตูุงุญ</h3>
        </div>

        <div class="slide-card">
          <img src="images/person11.jpg" alt="ูุญูุฏ" />
          <h3>ูุญูุฏ</h3>
        </div>

        <div class="slide-card">
          <img src="images/person6.jpg" alt="ููุญุฏ" />
          <h3>ููุญุฏ</h3>
        </div>

        <div class="slide-card">
          <img src="images/person7.jpg" alt="ุณูู ุงูุฏูู" />
          <h3>ุณูู ุงูุฏูู</h3>
        </div>

        <div class="slide-card">
          <img src="images/person8.jpg" alt="ุฃูุฌุฏ" />
          <h3>ุฃูุฌุฏ</h3>
        </div>

        <div class="slide-card">
          <img src="images/person9.jpg" alt="ุตุงูุญ" />
          <h3>ุตุงูุญ</h3>
        </div>

        <div class="slide-card">
          <img src="images/person10.jpg" alt="ุฃูุงุจ" />
          <h3>ุฃูุงุจ</h3>
        </div>

        <div class="slide-card">
          <img src="images/person10.jpg" alt="ูุงุณุฑ" />
          <h3>ูุงุณุฑ</h3>
        </div>
        
        <div class="slide-card">
          <img src="images/person10.jpg" alt="ุณูู ุงูุฏูู ูุญูุฏ" />
          <h3>ุณูู ุงูุฏูู ูุญูุฏ</h3>
        </div>
        
        <div class="slide-card">
          <img src="images/person10.jpg" alt="lol" />
          <h3>lol</h3>
        </div>

        <div class="slide-card">
          <img src="images/person13.jpg" alt="ุณุนุฏ" />
          <h3>ุณุนุฏ</h3>
        </div>

        </div>
      </div>
    </div>
  </section>
  <!-- =====================
       ุงูุนูุฏ
  ===================== -->
  <section id="ahd">
    <h2>ูุงุฆูุฉ ุงูุนูุฏ</h2>

    <div id="ahdCount" style="display:none" aria-hidden="true">โ</div>

    <div id="ahdPublicList" class="identity-grid" aria-label="ุฃุนุถุงุก ุงูุนูุฏ"></div>

    <div id="ahdAdminWrap" class="panel" style="margin-top:22px; display:none">
      <div class="panel-title">ุฅุฏุงุฑุฉ ุงูุนูุฏ (ุฃูุฌุฏ)</div>

      <div id="ahdManageBox" style="display:none; margin-top:16px">
        <div class="panel-sub" style="margin-bottom:10px">ุงุฎุชุฑ ุนุถููุง ูู ุงููุจููุฉ ูุฅุถุงูุชู ููุนูุฏุ ุฃู ุงุญุฐู ูู ูุงุฆูุฉ ุงูุนูุฏ.</div>

        <div class="today-layout" style="gap:14px">
          <aside class="today-side" style="flex:1">
            <div class="panel-title" style="margin-bottom:10px">ุฃุนุถุงุก ุงููุจููุฉ (ุบูุฑ ููุถููู)</div>
            <input id="ahdAdminSearch" class="text-input" type="text" placeholder="ุจุญุซ..." autocomplete="off" style="margin-bottom:10px" />
            <div id="tribeNotInAhdList" class="identity-grid" aria-label="ุฃุนุถุงุก ุงููุจููุฉ ุบูุฑ ุงูููุถููู"></div>
          </aside>

          <aside class="today-side" style="flex:1">
            <div class="panel-title" style="margin-bottom:10px">ุฃุนุถุงุก ุงูุนูุฏ</div>
            <div id="ahdManageList" class="identity-grid" aria-label="ุฃุนุถุงุก ุงูุนูุฏ ููุฅุฏุงุฑุฉ"></div>
          </aside>
        </div>

        <div class="panel-sub" style="margin-top:12px">ุงูุชุบููุฑุงุช ุชูุญูุธ ุนูู Firebase ูุชุธูุฑ ููุฌููุน ููุฑูุง.</div>
      </div>
    </div>
  </section>


  <!-- =====================
       ุงูุนุฏ ุงูุชูุงุฒูู
  ===================== -->
  <section id="countdown" class="countdown-section">
    <h2 class="countdown-title">ุงูุนุฏู ุงูุชูุงุฒูู ูุฑูุถุงู</h2>

    <div class="countdown">
      <div class="time-box">
        <span id="days">--</span>
        <small>ููู</small>
      </div>
      <div class="time-box">
        <span id="hours">--</span>
        <small>ุณุงุนุฉ</small>
      </div>
      <div class="time-box">
        <span id="minutes">--</span>
        <small>ุฏูููุฉ</small>
      </div>
      <div class="time-box seconds">
        <span id="seconds">--</span>
        <small>ุซูุงูู</small>
      </div>
    </div>
  </section>

  <!-- =====================
       ูุง ูู ูุงุฆูุฉ ุงูุนูุฏ
  ===================== -->
  <section id="about">
    <h2>ูุง ูู ูุงุฆูุฉ ุงูุนูุฏ</h2>
    <ul>
      <li>
        ูุงุฆูุฉ ุงูุนูุฏ ูู ุงูุชุฒุงู ุฌูุงุนู ุจูู ุฃุนุถุงุก ูุจููุฉ ูุงุนูุ
        ุจุนุฏู ุงููููุน ูู ุงููุญุฑูุงุชุ ููุฌุงูุฏุฉ ุงูููุณุ
        ูู ุงูุขู ูุญุชู ุดูุฑ ุฑูุถุงู ุงููุจุงุฑู.
      </li>
    </ul>
  </section>

  <!-- =====================
       ุงูููู
  ===================== -->
  <section id="values">
    <h2>ููููุง</h2>
    <ul>
      <li>ุงูุตุฏู ูุน ุงููู</li>
      <li>ุงููุนู ูุจู ุงููุนู</li>
      <li>ุงูุซุจุงุช ูุงูุงุณุชูุฑุงุฑูุฉ</li>
      <li>ุงูุฏุนู ุงูุฃุฎูู</li>
    </ul>
  </section>

  <!-- ุงูููุชุฑ -->
  <footer>
    <p>ยฉ 2026 ุงูููุญุฏูู โ ูุงุนู</p>
  </footer>

  <!-- =====================
       Azkar Modal (Reusable)
  ===================== -->
  <div class="azkar-modal-overlay" id="azkarModal" aria-hidden="true">
    <div class="azkar-modal-card" role="dialog" aria-modal="true" aria-labelledby="azkarModalTitle">
      <div class="azkar-modal-head">
        <div class="azkar-modal-title" id="azkarModalTitle">โ</div>

        <div class="azkar-modal-tools">
          <input class="azkar-search" id="azkarSearch" type="search" placeholder="ุงุจุญุซ ุฏุงุฎู ุงูุฃุฐูุงุฑ..." />
          <button class="azkar-tool-btn" id="azkarFindBtn" type="button">ุจุญุซ</button>
          <button class="azkar-tool-btn ghost" id="azkarOpenNewTab" type="button">ูุชุญ</button>
          <button type="button" class="azkar-modal-close" id="closeAzkarModal" aria-label="ุฅุบูุงู">โ</button>
        </div>
      </div>

      <div class="azkar-modal-body">
        <iframe
          id="azkarFrame"
          class="azkar-iframe"
          title="Azkar"
          loading="lazy"
          referrerpolicy="no-referrer"
        ></iframe>
      </div>

      <div class="azkar-modal-foot">
        <div class="azkar-note" id="azkarNote">โ</div>
        <button type="button" class="azkar-modal-close-btn" id="closeAzkarModal2">ุฅุบูุงู</button>
      </div>
    </div>
  </div>

  <div class="azkar-toast" id="azkarToast" aria-live="polite" aria-atomic="true"></div>

  <!-- =====================
       Quran Modal (10 pages/day)
  ===================== -->
  <div class="quran-modal-overlay" id="quranModal" aria-hidden="true">
    <div class="quran-modal-card" role="dialog" aria-modal="true" aria-labelledby="quranModalTitle">
      <div class="quran-modal-head">
        <div>
          <div class="quran-modal-title" id="quranModalTitle">ูุฑุงุกุฉ ุงูููู</div>
          <div class="quran-modal-sub" id="quranModalSub">โ</div>
        </div>

        <div class="quran-modal-tools">
          <button class="quran-tool-btn ghost" id="quranCopyPlan" type="button">ูุณุฎ ุงูุฎุทุฉ</button>
          <button class="quran-tool-btn" id="quranMarkDone" type="button">ุชู โ๏ธ</button>
          <button type="button" class="quran-modal-close" id="closeQuranModal" aria-label="ุฅุบูุงู">โ</button>
        </div>
      </div>

      <div class="quran-modal-body">
        <div class="quran-page-nav" id="quranPageNav"></div>

        <div class="quran-loader" id="quranLoader">ุฌุงุฑู ุชุญููู ุตูุญุงุช ุงููููโฆ</div>
        <div class="quran-pages" id="quranPages"></div>

        <div class="quran-error" id="quranError" hidden>
          ุชุนุฐูุฑ ุชุญููู ุงูุตูุญุงุช ุงูุขู. ุชุฃูุฏ ูู ุงูุฅูุชุฑูุช ูุญุงูู ูุฑุฉ ุซุงููุฉ.
        </div>
      </div>

      <div class="quran-modal-foot">
        <div class="quran-note">ูุตุฏุฑ ุงูุจูุงูุงุช: Quran.com API (Madani Mushaf pages 1โ604)</div>
        <button type="button" class="quran-modal-close-btn" id="closeQuranModal2">ุฅุบูุงู</button>
      </div>
    </div>
  </div>


  <!-- =====================
       Hadith Modal (5/day)
  ===================== -->
  <div class="tafsir-modal-overlay" id="hadithModal" aria-hidden="true">
    <div class="tafsir-modal-card" role="dialog" aria-modal="true" aria-labelledby="hadithModalTitle">
      <div class="tafsir-modal-head">
        <div>
          <div class="tafsir-modal-title" id="hadithModalTitle">ุฃุญุงุฏูุซ ุงูููู (ุตุญูุญุฉ)</div>
          <div class="tafsir-modal-sub" id="hadithModalSub">โ</div>
        </div>

        <div class="tafsir-modal-tools">
          <button class="tafsir-tool-btn ghost" id="hadithCopy" type="button">ูุณุฎ ุงูุฃุญุงุฏูุซ</button>
          <button class="tafsir-tool-btn" id="hadithMarkDone" type="button">ุชู โ๏ธ</button>
          <button type="button" class="tafsir-modal-close" id="closeHadithModal" aria-label="ุฅุบูุงู">โ</button>
        </div>
      </div>

      <div class="tafsir-modal-body">
        <div class="tafsir-page-nav" id="hadithMeta"></div>
        <div class="tafsir-pages" id="hadithList"></div>
      </div>

      <div class="tafsir-modal-foot">
        <div class="tafsir-note">ุงููุตุงุฏุฑ: ุตุญูุญ ุงูุจุฎุงุฑู ูุตุญูุญ ูุณูู</div>
        <button type="button" class="tafsir-modal-close-btn" id="closeHadithModal2">ุฅุบูุงู</button>
      </div>
    </div>
  </div>



  <!-- =====================
       Admin Login Modal (Amjad)
  ===================== -->
  <div class="tafsir-modal-overlay" id="adminLoginModal" aria-hidden="true">
    <div class="tafsir-modal-card" role="dialog" aria-modal="true" aria-labelledby="adminLoginTitle">
      <div class="tafsir-modal-head">
        <div>
          <div class="tafsir-modal-title" id="adminLoginTitle">ุฏุฎูู ุฃูุฌุฏ</div>
          <div class="tafsir-modal-sub">ุฃุฏุฎู ุงูุจุฑูุฏ ููููุฉ ุงููุฑูุฑ ููุฏุฎูู ููุณุคูู.</div>
        </div>
        <button type="button" class="tafsir-modal-close" id="closeAdminLoginModal" aria-label="ุฅุบูุงู">ร</button>
      </div>

      <div class="tafsir-modal-body">
        <div class="identity-guest" style="gap:10px; flex-wrap:wrap; justify-content:center">
          <input id="adminLoginEmail" class="text-input" type="email" inputmode="email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" autocomplete="username" style="min-width:240px" />
          <input id="adminLoginPassword" class="text-input" type="password" placeholder="ูููุฉ ุงููุฑูุฑ" autocomplete="current-password" style="min-width:200px" />
          <button id="adminLoginSubmitBtn" class="identity-btn" type="button">ุชุณุฌูู ุงูุฏุฎูู</button>
          <button id="adminLoginCancelBtn" class="identity-btn ghost" type="button">ุฅูุบุงุก</button>
        </div>
        <div id="adminLoginStatus" class="panel-sub" style="margin-top:10px; text-align:center"></div>
      </div>
    </div>
  </div>

  <!-- =====================
       JavaScript
  ===================== -->
  
  </div>

<script>
    const CONFIG = {
      RAMADAN_DATE_ISO: "2026-02-17T00:00:00",
      FORCE_HIZB_NUMBER: null,

      LINKS: {
        DEFAULT_TAFSIR: "https://example.com/tafsir",
        DEFAULT_RECOVERY_ARTICLE: "https://example.com/recovery-article",
      },

      CHALLENGES: [
        "ุชูุฑูู ุงูุถุบุท 10 ูุฑุงุช",
        "ุชุฑุชูุจ ุงูุบุฑูุฉ 10 ุฏูุงุฆู",
        "ูุดู 15 ุฏูููุฉ",
        "ุดุฑุจ 6 ุฃููุงุจ ูุงุก",
        "ูุฑุงุกุฉ 10 ุตูุญุงุช ูููุฏุฉ",
        "ุจูุงูู 45 ุซุงููุฉ",
      ],

      BREATH: {
        TOTAL_SECONDS: 60,
        PATTERN_TEXT: "ุดููู 4 โข ุญุจุณ 2 โข ุฒููุฑ 6",
      },

      AZKAR: {
        MORNING: {
          title: "ุฃุฐูุงุฑ ุงูุตุจุงุญ",
          url: "https://www.islambook.com/AzkarPrint/1",
          note: "ุงููุตุฏุฑ: islambook (ูุณุฎุฉ ุงูุทุจุงุนุฉ ูุฃุฐูุงุฑ ุงูุตุจุงุญ)",
        },
        EVENING: {
          title: "ุฃุฐูุงุฑ ุงููุณุงุก",
          url: "https://www.islambook.com/AzkarPrint/2",
          note: "ุงููุตุฏุฑ: islambook (ูุณุฎุฉ ุงูุทุจุงุนุฉ ูุฃุฐูุงุฑ ุงููุณุงุก)",
        },
      },

      TAFSIR: {
        NAME: "ุชูุณูุฑ ุงุจู ูุซูุฑ",
        RESOURCE_ID: null,
        RESOURCES_API: "https://api.quran.com/api/v4/resources/tafsirs",
      },

      QURAN: {
            START_DATE_ISO: "2026-01-26T00:00:00", // ุบููุฑู ูุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุชุญุฏู (ููุณู ููุฌููุน)
            TOTAL_PAGES: 604,
            PAGES_PER_DAY: 10,
            API_BASE: "https://api.quran.com/api/v4/verses/by_page/",
            FIELDS: "text_uthmani,verse_key",
       },
    };

    const TASK_KEYS = [
      "attendance",
      "morning_adhkar",
      "quran_hizb",
      "hadith",
      "recovery_article",
      "deep_breath",
      "challenge",
      "evening_adhkar",
    ];

    const WA3I_CTX = { todayISO: null, state: null };
    let breathInterval = null;

    function qs(sel) { return document.querySelector(sel); }
    function qsa(sel) { return Array.from(document.querySelectorAll(sel)); }
    function pad2(n) { return String(n).padStart(2, "0"); }

    

    
// ---------------------------
// Identity (local app user)
// ---------------------------
const USER_STORAGE_KEY = "wa3i_current_user_v1";
let WA3I_USER = null;
let COUNTDOWN_INTERVAL_ID = null;

function slugifyName(name) {
  const s = String(name || "").trim();
  if (!s) return "guest";
  return s
    .replace(/[^\u0600-\u06FFa-zA-Z0-9]+/g, "_")
    .replace(/^_+|_+$/g, "") || "guest";
}

function currentUserId() {
  return WA3I_USER?.id || "guest";
}

function readCurrentUser() {
  // Intentionally disabled: we never persist or restore the last user.
  return null;
}

function saveCurrentUser(user) {
  WA3I_USER = user;
  updateUserBar();
}

function clearCurrentUser() {
  WA3I_USER = null;
  updateUserBar();
}

function updateUserBar() {
  const pill = qs("#currentUserPill");
  if (pill) pill.textContent = WA3I_USER?.name || "ุถูู";
}

function showGate() {
  qs("#identityGate")?.classList.remove("is-hidden");
  const app = qs("#appRoot");
  if (app) {
    app.classList.add("is-hidden");
    app.setAttribute("aria-hidden", "true");
  }
}

function hideGate() {
  qs("#identityGate")?.classList.add("is-hidden");
  const app = qs("#appRoot");
  if (app) {
    app.classList.remove("is-hidden");
    app.setAttribute("aria-hidden", "false");
  }
  updateUserBar();
}

function readMembersFromDOM() {
  const cards = qsa("#members .slide-card");
  const out = [];
  cards.forEach((card, idx) => {
    const img = card.querySelector("img");
    const nameEl = card.querySelector("h3");
    const name = (nameEl?.textContent || img?.getAttribute("alt") || "").trim();
    const src = img?.getAttribute("src") || "";
    if (!name || !src) return;
    out.push({
      id: `member_${idx}`,
      name,
      src,
    });
  });
  return out;
}


function decorateMemberCardsWithStreaks() {
  const cards = qsa("#members .slide-card");
  cards.forEach((card, idx) => {
    const nameEl = card.querySelector("h3");
    if (!nameEl) return;

    let row = card.querySelector(".member-name-row");
    if (!row) {
      row = document.createElement("div");
      row.className = "member-name-row";
      nameEl.parentNode?.insertBefore(row, nameEl);
      row.appendChild(nameEl);
    }

    let badge = row.querySelector(".streak-badge");
    if (!badge) {
      badge = document.createElement("span");
      badge.className = "streak-badge member-streak-badge";
      row.appendChild(badge);
    }

    const streak = getStreakForUserId(`member_${idx}`);
    if (streak > 0) {
      badge.textContent = `๐ฅ${formatArabicNumber(streak)}`;
      badge.style.display = "";
    } else {
      badge.textContent = "";
      badge.style.display = "none";
    }
  });
}

function renderIdentityGrid(members, filterText = "") {
  const grid = qs("#identityGrid");
  if (!grid) return;

  const q = String(filterText || "").trim();
  const list = q ? members.filter((m) => m.name.includes(q)) : members;

  grid.innerHTML = list.length
    ? list
        .map((m) => {
          const streak = getStreakForUserId(m.id);
          const badge = streak > 0 ? ` <span class="streak-badge">๐ฅ${formatArabicNumber(streak)}</span>` : "";
          return `
        <button class="identity-item" type="button" data-user-id="${m.id}" aria-label="${m.name}">
          <img class="identity-avatar" src="${m.src}" alt="${m.name}" />
          <div class="identity-name">${m.name}${badge}</div>
        </button>
      `;
        })
        .join("")
    : `<div class="identity-empty">ูุง ุชูุฌุฏ ูุชุงุฆุฌโฆ ุฌุฑูุจ ุงุณููุง ุขุฎุฑ ุฃู ุงุฏุฎู ูุถูู.</div>`;

  grid.querySelectorAll(".identity-item").forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-user-id");
      const user = members.find((x) => x.id === id);
      if (!user) return;

      if (isAmjadMember(user)) {
        wireAdminLoginModal();
        openAdminLoginModal(user);
        return;
      }

      saveCurrentUser({ id: user.id, name: user.name, kind: "member" });
      startApp();
    });
  });
}

function wireGuestEntry() {
  const btn = qs("#enterGuestBtn");
  const input = qs("#guestName");

  const enter = () => {
    const raw = (input?.value || "").trim();
    const name = raw || "ุถูู";
    const id = raw ? `guest_${slugifyName(raw)}` : "guest";
    saveCurrentUser({ id, name, kind: "guest" });
    if (input) input.value = "";
    startApp();
  };

  btn?.addEventListener("click", enter);
  input?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") enter();
  });
}

function closeAllModals() {
  document.querySelectorAll(".tafsir-modal-overlay.open").forEach((m) => {
    m.classList.remove("open");
    m.setAttribute("aria-hidden", "true");
  });
  document.body.style.overflow = "";
}

let PENDING_ADMIN_USER = null;
let ADMIN_MODAL_WIRED = false;

function isAmjadMember(user) {
  return Boolean(user && String(user.name || "").trim() === "ุฃูุฌุฏ");
}

function openAdminLoginModal(user) {
  PENDING_ADMIN_USER = user;

  const modal = qs("#adminLoginModal");
  const status = qs("#adminLoginStatus");
  const email = qs("#adminLoginEmail");
  const pass = qs("#adminLoginPassword");

  if (status) status.textContent = "";
  if (email) email.value = "";
  if (pass) pass.value = "";

  if (!modal) return;

  modal.classList.add("open");
  modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";

  // Focus password first (you usually paste email once)
  setTimeout(() => {
    (email || pass)?.focus?.();
  }, 50);
}

function closeAdminLoginModal() {
  const modal = qs("#adminLoginModal");
  if (!modal) return;
  modal.classList.remove("open");
  modal.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
  PENDING_ADMIN_USER = null;
}

async function submitAdminLogin() {
  const status = qs("#adminLoginStatus");
  const email = (qs("#adminLoginEmail")?.value || "").trim();
  const password = (qs("#adminLoginPassword")?.value || "").trim();

  if (!email || !password) {
    if (status) status.textContent = "ุงูุชุจ ุงูุจุฑูุฏ ููููุฉ ุงููุฑูุฑ.";
    return;
  }

  const trySignIn = async () => {
    if (!fbAvailable()) throw new Error("FB_NOT_READY");
    const { auth, setPersistence, inMemoryPersistence, signInWithEmailAndPassword } = window.FB;

    // Force "ask every time": do not persist the session.
    await setPersistence(auth, inMemoryPersistence);
    return signInWithEmailAndPassword(auth, email, password);
  };

  try {
    if (status) status.textContent = "ุฌุงุฑู ุชุณุฌูู ุงูุฏุฎููโฆ";
    await trySignIn();

    // Success: enter app as Amjad.
    const pending = PENDING_ADMIN_USER;
    closeAdminLoginModal();
    if (pending) {
      saveCurrentUser({ id: pending.id, name: pending.name, kind: "member" });
      startApp();
    }
  } catch (e) {
    if (String(e?.message || "").includes("FB_NOT_READY")) {
      if (status) status.textContent = "ุงูุชุธุฑ ูุญุธุฉโฆ";
      setTimeout(submitAdminLogin, 250);
      return;
    }
    if (status) status.textContent = "ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ ุฃู ูุง ููุฌุฏ ุงุชุตุงู.";
  }
}

function wireAdminLoginModal() {
  if (ADMIN_MODAL_WIRED) return;
  ADMIN_MODAL_WIRED = true;

  const modal = qs("#adminLoginModal");
  const closeBtn = qs("#closeAdminLoginModal");
  const cancelBtn = qs("#adminLoginCancelBtn");
  const submitBtn = qs("#adminLoginSubmitBtn");
  const pass = qs("#adminLoginPassword");

  closeBtn?.addEventListener("click", closeAdminLoginModal);
  cancelBtn?.addEventListener("click", closeAdminLoginModal);
  submitBtn?.addEventListener("click", submitAdminLogin);

  pass?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") submitAdminLogin();
  });

  // Click outside closes
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) closeAdminLoginModal();
  });
}

function wireSwitchUserButton() {
  const btn = qs("#switchUserBtn");
  if (!btn) return;

  btn.addEventListener("click", async () => {
    closeAllModals();
    if (COUNTDOWN_INTERVAL_ID) {
      clearInterval(COUNTDOWN_INTERVAL_ID);
      COUNTDOWN_INTERVAL_ID = null;
    }

    clearCurrentUser();

    // Force "ask every time" for Amjad: sign out Firebase on user switch.
    try {
      if (fbAvailable()) await window.FB.signOut(window.FB.auth);
    } catch {}

    initIdentityGate();
  });
}

function startApp() {
  hideGate();
  initCountdown();
  initDailyFlow();
  setupAzkarModal();
  initAhdPage();
}

function initIdentityGate() {
  showGate();

  const members = readMembersFromDOM();
  renderIdentityGrid(members);

  const lastBox = qs("#identityLast");
  if (lastBox) {
    lastBox.classList.add("is-hidden");
    lastBox.innerHTML = "";
  }

  const search = qs("#identitySearch");
  if (search) {
    search.value = "";
    search.addEventListener("input", () => renderIdentityGrid(members, search.value));
  }

  wireGuestEntry();
  wireSwitchUserButton();
}

function userKey(suffix) {
  return `wa3i_${currentUserId()}_${suffix}`;
}

function getStreakForUserId(userId) {
  const raw = localStorage.getItem(`wa3i_${userId}_streak`);
  const n = parseInt(raw || "0", 10);
  return Number.isFinite(n) ? n : 0;
}

// ---------------------------
// Ahd (Firebase Firestore + Auth)
// ---------------------------
// Firebase Ahd (Firestore + Auth)
// ---------------------------
const AMJAD_ADMIN_UID = "OpXzKToeVbd9xp1KHuqnD95yXlm2";

let FB_STATE = {
  ready: false,
  user: null,
  isAdmin: false,
  tribe: new Map(), // memberId -> {name, src}
  ahd: new Set(),   // memberId
  unsubscribers: [],
};

function fbAvailable() {
  return typeof window.FB !== "undefined" && window.FB?.db && window.FB?.auth;
}

function rebuildTribeMapFromDOM() {
  const members = readMembersFromDOM();
  FB_STATE.tribe = new Map(members.map((m) => [m.id, { name: m.name, src: m.src }]));
}

function setAhdAdminVisibility() {
  const wrap = qs("#ahdAdminWrap");
  const manageBox = qs("#ahdManageBox");
  if (wrap) wrap.style.display = FB_STATE.isAdmin ? "block" : "none";
  if (manageBox) manageBox.style.display = FB_STATE.isAdmin ? "block" : "none";
}

function renderAhdPublicList() {
  const el = qs("#ahdPublicList");
  const count = qs("#ahdCount");
  if (!el || !count) return;

  const ahdMembers = Array.from(FB_STATE.ahd)
    .map((id) => ({ id, ...(FB_STATE.tribe.get(id) || { name: id, src: "" }) }))
    .sort((a, b) => (a.name || "").localeCompare(b.name || "", "ar"));

  count.textContent = `${formatArabicNumber(ahdMembers.length)} ุนุถู`;

  el.innerHTML = ahdMembers.length
    ? ahdMembers
        .map(
          (m) => `
        <div class="identity-item" style="cursor:default">
          <img class="identity-avatar" src="${m.src || "images/person1.jpg"}" alt="${escapeHtml(m.name || m.id)}" />
          <div class="identity-name">${escapeHtml(m.name || m.id)}</div>
        </div>
      `
        )
        .join("")
    : `<div class="identity-empty">ูุง ููุฌุฏ ุฃุนุถุงุก ูู ุงูุนูุฏ ุจุนุฏ.</div>`;

  if (FB_STATE.isAdmin) {
    renderAhdAdminLists(qs("#ahdAdminSearch")?.value || "");
  }
}

function renderAhdAdminLists(filterText = "") {
  const notInEl = qs("#tribeNotInAhdList");
  const ahdEl = qs("#ahdManageList");
  if (!notInEl || !ahdEl) return;

  const q = String(filterText || "").trim();

  const tribeList = Array.from(FB_STATE.tribe.entries()).map(([id, m]) => ({ id, ...m }));
  const notIn = tribeList
    .filter((m) => !FB_STATE.ahd.has(m.id))
    .filter((m) => (q ? (m.name || "").includes(q) : true))
    .sort((a, b) => (a.name || "").localeCompare(b.name || "", "ar"));

  const inAhd = tribeList
    .filter((m) => FB_STATE.ahd.has(m.id))
    .sort((a, b) => (a.name || "").localeCompare(b.name || "", "ar"));

  notInEl.innerHTML = notIn.length
    ? notIn
        .map(
          (m) => `
        <button class="identity-item" type="button" data-add-ahd="${m.id}" aria-label="ุฅุถุงูุฉ ${escapeHtml(m.name)}">
          <img class="identity-avatar" src="${m.src}" alt="${escapeHtml(m.name)}" />
          <div class="identity-name">${escapeHtml(m.name)}</div>
        </button>
      `
        )
        .join("")
    : `<div class="identity-empty">ูุง ููุฌุฏ ุฃุนุถุงุก ูุชุงุญูู ููุฅุถุงูุฉ.</div>`;

  ahdEl.innerHTML = inAhd.length
    ? inAhd
        .map(
          (m) => `
        <button class="identity-item" type="button" data-remove-ahd="${m.id}" aria-label="ุญุฐู ${escapeHtml(m.name)}">
          <img class="identity-avatar" src="${m.src}" alt="${escapeHtml(m.name)}" />
          <div class="identity-name">${escapeHtml(m.name)}</div>
        </button>
      `
        )
        .join("")
    : `<div class="identity-empty">ูุง ููุฌุฏ ุฃุนุถุงุก ูู ุงูุนูุฏ.</div>`;

  notInEl.querySelectorAll("[data-add-ahd]").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-add-ahd");
      await addMemberToAhd(id);
    });
  });

  ahdEl.querySelectorAll("[data-remove-ahd]").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-remove-ahd");
      const ok = confirm("ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูุนุถู ูู ุงูุนูุฏุ");
      if (!ok) return;
      await removeMemberFromAhd(id);
    });
  });
}

async function addMemberToAhd(memberId) {
  if (!FB_STATE.isAdmin) return;
  const id = String(memberId || "").trim();
  if (!id) return;

  const { db, doc, setDoc, serverTimestamp } = window.FB;
  await setDoc(doc(db, "ahdMembers", id), { joinedAt: serverTimestamp() }, { merge: true });
}

async function removeMemberFromAhd(memberId) {
  if (!FB_STATE.isAdmin) return;
  const id = String(memberId || "").trim();
  if (!id) return;

  const { db, doc, deleteDoc } = window.FB;
  await deleteDoc(doc(db, "ahdMembers", id));
}

function attachAhdFirestoreListener() {
  const { db, onSnapshot, collection } = window.FB;

  // Clean old listeners if any
  FB_STATE.unsubscribers.forEach((u) => {
    try {
      u();
    } catch {}
  });
  FB_STATE.unsubscribers = [];

  const unsubAhd = onSnapshot(collection(db, "ahdMembers"), (snap) => {
    FB_STATE.ahd = new Set();
    snap.forEach((docSnap) => FB_STATE.ahd.add(docSnap.id));
    renderAhdPublicList();
  });

  FB_STATE.unsubscribers.push(unsubAhd);
}

function initAhdPage() {
  // Always use local (DOM) tribe members for names/avatars.
  rebuildTribeMapFromDOM();

  const tryInit = () => {
    if (!fbAvailable()) return setTimeout(tryInit, 50);
    if (FB_STATE.ready) return;

    FB_STATE.ready = true;

    window.FB.onAuthStateChanged(window.FB.auth, (user) => {
      FB_STATE.user = user || null;
      FB_STATE.isAdmin = Boolean(user && user.uid === AMJAD_ADMIN_UID);

      setAhdAdminVisibility();
      renderAhdPublicList();
    });

    // Admin search input
    qs("#ahdAdminSearch")?.addEventListener("input", (e) => {
      if (!FB_STATE.isAdmin) return;
      renderAhdAdminLists(e.target.value || "");
    });

    attachAhdFirestoreListener();
    setAhdAdminVisibility();
    renderAhdPublicList();
  };

  tryInit();
}

function toLocalISODate(d) {
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    }

    function dayOfYear(d) {
      const start = new Date(d.getFullYear(), 0, 0);
      return Math.floor((d - start) / 86400000);
    }

    function formatArabicNumber(n) {
      return String(n).replace(/\d/g, (d) => "ููกูขูฃูคูฅูฆูงูจูฉ"[Number(d)]);
    }

    function storageKeyForToday(isoDate) {
      return `wa3i_${currentUserId()}_daily_${isoDate}`;
    }

    function getDailyState(isoDate) {
      const raw = localStorage.getItem(storageKeyForToday(isoDate));
      if (!raw) return null;
      try {
        const st = JSON.parse(raw);
        if (st && st.tasks && typeof st.tasks === "object") {
          if (st.tasks.hadith === undefined && st.tasks.tafsir !== undefined) {
            st.tasks.hadith = Boolean(st.tasks.tafsir);
          }
          TASK_KEYS.forEach((k) => {
            if (st.tasks[k] === undefined) st.tasks[k] = false;
          });
        }
        return st;
      } catch {
        return null;
      }
    }

    function setDailyState(isoDate, state) {
      localStorage.setItem(storageKeyForToday(isoDate), JSON.stringify(state));
    }

    function defaultDailyState() {
      const tasks = {};
      TASK_KEYS.forEach((k) => (tasks[k] = false));
      return {
        tasks,
        breathSecondsLeft: CONFIG.BREATH.TOTAL_SECONDS,
        breathRunning: false,
        completedAll: false,
        completedAt: null,
      };
    }

    function setCheckbox(taskKey, checked) {
      const el = qs(`input[type="checkbox"][data-task="${taskKey}"]`);
      if (el) el.checked = Boolean(checked);
    }

    function isAllCompleted(state) {
      return TASK_KEYS.every((k) => Boolean(state.tasks[k]));
    }

    function getStreak() {
      const raw = localStorage.getItem(userKey("streak"));
      const n = parseInt(raw || "0", 10);
      return Number.isFinite(n) ? n : 0;
    }

function setStreak(n) {
      localStorage.setItem(userKey("streak"), String(n));
      const el = qs("#streakCount");
      if (el) el.textContent = String(n);
    }

function getLastCompletedDate() {
      return localStorage.getItem(userKey("last_completed_date"));
    }

function setLastCompletedDate(isoDate) {
      localStorage.setItem(userKey("last_completed_date"), isoDate);
    }

function previousISODate(isoDate) {
      const [y, m, d] = isoDate.split("-").map(Number);
      const dt = new Date(y, m - 1, d);
      dt.setDate(dt.getDate() - 1);
      return toLocalISODate(dt);
    }

    function updateProgressUI(state) {
      const done = TASK_KEYS.filter((k) => state.tasks[k]).length;
      const pct = Math.round((done / TASK_KEYS.length) * 100);

      qs("#progressText").textContent = `${pct}%`;
      qs("#progressFill").style.width = `${pct}%`;

      qs("#progressSub").textContent =
        pct === 100 ? "ุชูุช ุฑุญูุฉ ุงูููู ุจุงููุงููโฆ ุซุจุชู ุงููู ๐ค" :
        pct >= 60 ? "ูุฑูุจ ุฌุฏูุงโฆ ุฃููู ูุงุฑุชุงุญ." :
        pct >= 25 ? "ุจุฏุงูุฉ ููุชุงุฒุฉโฆ ูุงุตู." :
        "ุงุจุฏุฃ ุจุฎุทูุฉ ูุงุญุฏุฉโฆ ุซู ุฃููู.";
    }

    function maybeUpdateStreakOnFullCompletion(todayISO, state) {
      if (!isAllCompleted(state)) return;
      if (state.completedAll) return;

      const last = getLastCompletedDate();
      const yesterday = previousISODate(todayISO);

      let streak = getStreak();
      if (last === yesterday) streak += 1;
      else if (last === todayISO) streak = streak;
      else streak = 1;

      state.completedAll = true;
      state.completedAt = new Date().toISOString();

      setStreak(streak);
      setLastCompletedDate(todayISO);
    }

    function applyLinks() {
  const recovery = qs("#recoveryLink");
  if (recovery) recovery.href = CONFIG.LINKS.DEFAULT_RECOVERY_ARTICLE;
}

    // ---------------------------
    // Countdown
    // ---------------------------
    function initCountdown() {
      const ramadanDate = new Date(CONFIG.RAMADAN_DATE_ISO).getTime();

      function updateCountdown() {
        const now = new Date().getTime();
        const diff = ramadanDate - now;

        if (diff <= 0) {
          const el = document.querySelector(".countdown");
          if (el) el.innerHTML = "<p style='color:#7cf2a4;font-size:22px'>๐ ุฑูุถุงู ูุจุงุฑู ๐</p>";
          return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((diff / (1000 * 60)) % 60);
        const seconds = Math.floor((diff / 1000) % 60);

        qs("#days").textContent = days;
        qs("#hours").textContent = hours;
        qs("#minutes").textContent = minutes;
        qs("#seconds").textContent = seconds;
      }

      updateCountdown();
      if (COUNTDOWN_INTERVAL_ID) clearInterval(COUNTDOWN_INTERVAL_ID);
      COUNTDOWN_INTERVAL_ID = setInterval(updateCountdown, 1000);
    }

    // ---------------------------
    // Breath timer
    // ---------------------------
    function fmtTime(totalSeconds) {
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      return `${pad2(m)}:${pad2(s)}`;
    }

    function setBreathUI(state) {
      qs("#breathTime").textContent = fmtTime(state.breathSecondsLeft);
      qs("#breathHint").textContent = CONFIG.BREATH.PATTERN_TEXT;

      const done = Boolean(state.tasks.deep_breath);
      const pill = qs("#breathStatus");
      pill.textContent = done ? "ููุชูู โ๏ธ" : "ุบูุฑ ููุชูู";
      pill.classList.toggle("ok", done);

      qs("#breathStart").textContent = state.breathRunning ? "ุฅููุงู" : "ุงุจุฏุฃ";
    }

    function stopBreathTimer(state) {
      if (breathInterval) {
        clearInterval(breathInterval);
        breathInterval = null;
      }
      state.breathRunning = false;
      setBreathUI(state);
    }

    function startBreathTimer(todayISO, state) {
      if (state.breathRunning) {
        stopBreathTimer(state);
        setDailyState(todayISO, state);
        return;
      }

      state.breathRunning = true;
      setBreathUI(state);
      setDailyState(todayISO, state);

      breathInterval = setInterval(() => {
        if (!state.breathRunning) return;

        state.breathSecondsLeft = Math.max(0, state.breathSecondsLeft - 1);

        if (state.breathSecondsLeft === 0) {
          state.tasks.deep_breath = true;
          setCheckbox("deep_breath", true);
          stopBreathTimer(state);
          updateProgressUI(state);
          maybeUpdateStreakOnFullCompletion(todayISO, state);
        }

        setBreathUI(state);
        setDailyState(todayISO, state);
      }, 1000);
    }

    function resetBreathTimer(todayISO, state) {
      stopBreathTimer(state);
      state.breathSecondsLeft = CONFIG.BREATH.TOTAL_SECONDS;
      setBreathUI(state);
      setDailyState(todayISO, state);
    }

    // ---------------------------
    // Toast
    // ---------------------------
    function showToast(msg) {
      const t = qs("#azkarToast");
      if (!t) return;
      t.textContent = msg;
      t.classList.add("open");
      window.setTimeout(() => t.classList.remove("open"), 2400);
    }

    // ---------------------------
    // Azkar Modal
    // ---------------------------
    function setupAzkarModal() {
      const modal = qs("#azkarModal");
      const frame = qs("#azkarFrame");
      const title = qs("#azkarModalTitle");
      const note = qs("#azkarNote");
      const search = qs("#azkarSearch");
      const findBtn = qs("#azkarFindBtn");
      const openBtn = qs("#azkarOpenNewTab");
      const closeBtn = qs("#closeAzkarModal");
      const closeBtn2 = qs("#closeAzkarModal2");

      let currentUrl = null;

      function openModal(cfg) {
        currentUrl = cfg.url;
        title.textContent = cfg.title;
        note.textContent = cfg.note;
        search.value = "";
        frame.src = cfg.url;

        modal.classList.add("open");
        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        modal.classList.remove("open");
        modal.setAttribute("aria-hidden", "true");
        frame.src = "about:blank";
        currentUrl = null;
        document.body.style.overflow = "";
      }

      qs("#openMorningAzkar").addEventListener("click", () => openModal(CONFIG.AZKAR.MORNING));
      qs("#openEveningAzkar").addEventListener("click", () => openModal(CONFIG.AZKAR.EVENING));

      closeBtn.addEventListener("click", closeModal);
      closeBtn2.addEventListener("click", closeModal);

      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("open")) closeModal();
      });

      openBtn.addEventListener("click", () => {
        if (!currentUrl) return;
        window.open(currentUrl, "_blank", "noopener,noreferrer");
      });

      async function doFind() {
        const q = (search.value || "").trim();
        if (!q) return;

        try {
          const ok = frame.contentWindow && frame.contentWindow.find && frame.contentWindow.find(q);
          if (ok) return;
        } catch { /* cross-origin */ }

        try {
          await navigator.clipboard.writeText(q);
          showToast(`ุงูุณุฎูุง "${q}". ุฏุงุฎู ุงูุฃุฐูุงุฑ ุงุถุบุท Ctrl+F ุซู ูุตู`);
        } catch {
          showToast(`ุฏุงุฎู ุงูุฃุฐูุงุฑ ุงุถุบุท Ctrl+F ูุงุจุญุซ ุนู: ${q}`);
        }
      }

      findBtn.addEventListener("click", doFind);
      search.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doFind();
      });
    }

    // ---------------------------
    // Quran (10 pages/day)
    // ---------------------------
    function getOrInitQuranStartDate(today) {
      const key = "wa3i_quran_start_day_v1"; // ูุจุฏุฃ ูู ุฃูู ุตูุญุฉ ููู ุชุดุบูู ุฃูู ูุฑุฉ
      let stored = localStorage.getItem(key);

      if (!stored) {
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, "0");
        const d = String(today.getDate()).padStart(2, "0");
        stored = `${y}-${m}-${d}`;
        localStorage.setItem(key, stored);
      }

      const parts = stored.split("-").map((v) => parseInt(v, 10));
      if (parts.length === 3 && parts.every((n) => Number.isFinite(n))) {
        const [y, m, d] = parts;
        return new Date(y, m - 1, d);
      }

      const startDateRaw = new Date(CONFIG.QURAN.START_DATE_ISO);
      return new Date(startDateRaw.getFullYear(), startDateRaw.getMonth(), startDateRaw.getDate());
    }

    function computeDailyQuranPages(today) {
    const total = CONFIG.QURAN.TOTAL_PAGES;
    const perDay = CONFIG.QURAN.PAGES_PER_DAY;

    const startDate = getOrInitQuranStartDate(today);
    const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    const diffDays = Math.floor((todayLocal.getTime() - startDate.getTime()) / 86400000);
    const dayIndex = Math.max(0, diffDays); // ูุจู ุชุงุฑูุฎ ุงูุจุฏุงูุฉ => ุงูููู ุงูุฃูู

    const cycleLen = Math.ceil(total / perDay); // 604/10 => 61 ููู
    const dayInCycle = dayIndex % cycleLen;

    const start = (dayInCycle * perDay) + 1;
    const end = Math.min(total, start + perDay - 1);

    const pages = Array.from({ length: end - start + 1 }, (_, i) => start + i);
    return { start, end, pages };
    }

    async function fetchVersesByPage(pageNumber, opts = {}) {
      const tafsirId = Number.isFinite(opts?.tafsirId) ? opts.tafsirId : null;
      const cacheKey = tafsirId
        ? `wa3i_quran_page_${pageNumber}_tafsir_${tafsirId}_v2`
        : `wa3i_quran_page_${pageNumber}_v2`;

      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          if (parsed?.data && parsed?.savedAt && (Date.now() - parsed.savedAt) < 1000 * 60 * 60 * 24 * 30) {
            return parsed.data;
          }
        } catch { /* ignore */ }
      }

      const url =
        `${CONFIG.QURAN.API_BASE}${pageNumber}` +
        `?language=ar&words=false&fields=${encodeURIComponent(CONFIG.QURAN.FIELDS)}` +
        (tafsirId ? `&tafsirs=${encodeURIComponent(tafsirId)}` : "");

      const res = await fetch(url, { headers: { Accept: "application/json" } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const json = await res.json();
      const verses = Array.isArray(json?.verses) ? json.verses : [];

      const data = verses.map((v) => {
        const key = v.verse_key || "";
        const text = v.text_uthmani || v.text_qpc_hafs || v.text_imlaei || v.text || "";
        const tafsirHtml = Array.isArray(v.tafsirs) && v.tafsirs[0]?.text ? String(v.tafsirs[0].text) : "";
        return { key, text, tafsirHtml };
      }).filter((x) => x.text);

      localStorage.setItem(cacheKey, JSON.stringify({ savedAt: Date.now(), data }));
      return data;
    }

    function buildQuranNav(pages) {
      const nav = qs("#quranPageNav");
      nav.innerHTML = "";

      pages.forEach((p) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "quran-page-chip";
        btn.textContent = formatArabicNumber(p);
        btn.addEventListener("click", () => {
          const target = qs(`#quran-page-${p}`);
          if (target) target.scrollIntoView({ behavior: "smooth", block: "start" });
        });
        nav.appendChild(btn);
      });
    }

    function renderQuranPages(pages, pagesData) {
      const pagesEl = qs("#quranPages");
      pagesEl.innerHTML = "";

      for (const page of pages) {
        const verses = pagesData.get(page) || [];

        const pageCard = document.createElement("div");
        pageCard.className = "quran-page";
        pageCard.id = `quran-page-${page}`;

        const head = document.createElement("div");
        head.className = "quran-page-head";
        head.innerHTML = `<div class="quran-page-badge">ุตูุญุฉ ${formatArabicNumber(page)}</div>`;

        const body = document.createElement("div");
        body.className = "quran-text";

        verses.forEach((v) => {
          const ayahNo = (v.key.split(":")[1] || "").trim();

          const span = document.createElement("span");
          span.className = "quran-ayah";
          span.innerHTML = `
            <span class="ayah-text">${v.text}</span>
            ${ayahNo ? `<span class="ayah-num">${formatArabicNumber(ayahNo)}</span>` : ""}
          `;
          body.appendChild(span);
          body.appendChild(document.createTextNode(" "));
        });

        pageCard.appendChild(head);
        pageCard.appendChild(body);
        pagesEl.appendChild(pageCard);
      }
    }

    function setupQuranModal(quranPlan) {
      const modal = qs("#quranModal");
      const openBtn = qs("#openQuranReading");
      const closeBtn = qs("#closeQuranModal");
      const closeBtn2 = qs("#closeQuranModal2");
      const loader = qs("#quranLoader");
      const error = qs("#quranError");
      const title = qs("#quranModalTitle");
      const sub = qs("#quranModalSub");

      const copyPlanBtn = qs("#quranCopyPlan");
      const markDoneBtn = qs("#quranMarkDone");

      async function openModal() {
        title.textContent = "ูุฑุงุกุฉ ุงูููู";
        sub.textContent = `ุตูุญุงุช ${formatArabicNumber(quranPlan.start)} ุฅูู ${formatArabicNumber(quranPlan.end)}`;

        modal.classList.add("open");
        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        loader.hidden = false;
        error.hidden = true;
        qs("#quranPages").innerHTML = "";
        buildQuranNav(quranPlan.pages);

        try {
          const pagesData = new Map();
          for (const p of quranPlan.pages) {
            const verses = await fetchVersesByPage(p);
            pagesData.set(p, verses);
          }
          renderQuranPages(quranPlan.pages, pagesData);
          loader.hidden = true;
        } catch {
          loader.hidden = true;
          error.hidden = false;
        }
      }

      function closeModal() {
        modal.classList.remove("open");
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      }

      openBtn.addEventListener("click", openModal);
      closeBtn.addEventListener("click", closeModal);
      closeBtn2.addEventListener("click", closeModal);

      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("open")) closeModal();
      });

      copyPlanBtn.addEventListener("click", async () => {
        const txt = `ูุฑุงุกุฉ ุงูููู: ุตูุญุงุช ${quranPlan.start} ุฅูู ${quranPlan.end} (10 ุตูุญุงุช)`;
        try {
          await navigator.clipboard.writeText(txt);
          showToast("ุชู ูุณุฎ ุงูุฎุทุฉ โ");
        } catch {
          showToast("ุชุนุฐูุฑ ุงููุณุฎ ุชููุงุฆููุง");
        }
      });

      markDoneBtn.addEventListener("click", () => {
        if (!WA3I_CTX.state || !WA3I_CTX.todayISO) return;

        WA3I_CTX.state.tasks.quran_hizb = true;
        setCheckbox("quran_hizb", true);

        updateProgressUI(WA3I_CTX.state);
        maybeUpdateStreakOnFullCompletion(WA3I_CTX.todayISO, WA3I_CTX.state);
        setDailyState(WA3I_CTX.todayISO, WA3I_CTX.state);

        closeModal();
      });
    }


    

// ---------------------------
    // Hadith (5/day, ุซุงุจุช ูููุณ ุงูููู)
    // ---------------------------
    const HADITH_CFG = {
      CACHE_KEY: "wa3i_hadith_bank_cache_v1",
      CACHE_TTL_MS: 1000 * 60 * 60 * 24 * 30,
      REMOTE: {
        BUKHARI: "https://raw.githubusercontent.com/AhmedBaset/hadith-json/main/db/by_book/the_9_books/bukhari.json",
        MUSLIM: "https://raw.githubusercontent.com/AhmedBaset/hadith-json/main/db/by_book/the_9_books/muslim.json",
      },
      FALLBACK: [{"id": "fallback_1", "book": "ูุชูู ุนููู", "text": "ุฅููููููุง ุงูุฃูุนูููุงูู ุจูุงูููููููุงุชู."}, {"id": "fallback_2", "book": "ูุชูู ุนููู", "text": "ูููู ููุงูู ููุคููููู ุจูุงูููููู ููุงูููููููู ุงูุขุฎูุฑู ูููููููููู ุฎูููุฑูุง ุฃููู ููููุตูููุชู."}, {"id": "fallback_3", "book": "ูุชูู ุนููู", "text": "ููุง ููุคููููู ุฃูุญูุฏููููู ุญูุชููู ููุญูุจูู ููุฃูุฎูููู ููุง ููุญูุจูู ููููููุณููู."}, {"id": "fallback_4", "book": "ุตุญูุญ ูุณูู", "text": "ุงูุฏููููู ุงููููุตููุญูุฉู."}, {"id": "fallback_5", "book": "ุตุญูุญ ูุณูู", "text": "ุฅูููู ุงูููููู ุฌูููููู ููุญูุจูู ุงููุฌูููุงูู."}, {"id": "fallback_6", "book": "ุตุญูุญ ุงูุจุฎุงุฑู", "text": "ููุง ุชูุบูุถูุจู."}, {"id": "fallback_7", "book": "ูุชูู ุนููู", "text": "ุฃูุญูุจูู ุงูุฃูุนูููุงูู ุฅูููู ุงูููููู ุฃูุฏูููููููุง ููุฅููู ููููู."}, {"id": "fallback_8", "book": "ุตุญูุญ ูุณูู", "text": "ูููู ุณููููู ุทูุฑููููุง ููููุชูููุณู ููููู ุนูููููุง ุณูููููู ุงูููููู ูููู ุจููู ุทูุฑููููุง ุฅูููู ุงููุฌููููุฉู."}, {"id": "fallback_9", "book": "ุตุญูุญ ูุณูู", "text": "ููุง ููุฏูุฎููู ุงููุฌููููุฉู ูููู ููุงูู ููู ููููุจููู ููุซูููุงูู ุฐูุฑููุฉู ูููู ููุจูุฑู."}, {"id": "fallback_10", "book": "ูุชูู ุนููู", "text": "ุงููููุฑูุกู ููุนู ูููู ุฃูุญูุจูู."}],
    };

    function hash32(str) {
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }

    function mulberry32(seed) {
      let a = seed >>> 0;
      return function rnd() {
        a |= 0;
        a = (a + 0x6D2B79F5) | 0;
        let t = Math.imul(a ^ (a >>> 15), 1 | a);
        t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function safeJsonParse(raw, fallbackValue) {
      try {
        const v = JSON.parse(raw);
        return (v === null || v === undefined) ? fallbackValue : v;
      } catch {
        return fallbackValue;
      }
    }

    function normalizeRemoteHadith(bookLabel, item) {
      const id = item?.id;
      const text = (item?.arabic || "").trim();
      if (!Number.isFinite(id) || !text) return null;
      return {
        id: `${bookLabel}_${id}`,
        book: bookLabel === "bukhari" ? "ุตุญูุญ ุงูุจุฎุงุฑู" : "ุตุญูุญ ูุณูู",
        text,
      };
    }

    async function loadHadithBank() {
      const cachedRaw = localStorage.getItem(HADITH_CFG.CACHE_KEY);
      const cached = cachedRaw ? safeJsonParse(cachedRaw, null) : null;

      if (cached?.savedAt && Array.isArray(cached?.data)) {
        const age = Date.now() - Number(cached.savedAt);
        if (age >= 0 && age < HADITH_CFG.CACHE_TTL_MS) return cached.data;
      }

      try {
        const [bRes, mRes] = await Promise.all([
          fetch(HADITH_CFG.REMOTE.BUKHARI, { headers: { Accept: "application/json" } }),
          fetch(HADITH_CFG.REMOTE.MUSLIM, { headers: { Accept: "application/json" } }),
        ]);

        if (!bRes.ok || !mRes.ok) throw new Error("Hadith fetch failed");

        const [bJson, mJson] = await Promise.all([bRes.json(), mRes.json()]);
        const bArr = Array.isArray(bJson) ? bJson : [];
        const mArr = Array.isArray(mJson) ? mJson : [];

        const bank = [];
        bArr.forEach((it) => {
          const v = normalizeRemoteHadith("bukhari", it);
          if (v) bank.push(v);
        });
        mArr.forEach((it) => {
          const v = normalizeRemoteHadith("muslim", it);
          if (v) bank.push(v);
        });

        if (bank.length < 50) throw new Error("Hadith bank too small");

        localStorage.setItem(HADITH_CFG.CACHE_KEY, JSON.stringify({ savedAt: Date.now(), data: bank }));
        return bank;
      } catch {
        return HADITH_CFG.FALLBACK;
      }
    }

    function pickDailyHadithIds(todayISO, allIds, usedSet) {
      const available = allIds.filter((id) => !usedSet.has(id));
      const pool = available.length >= 5 ? available : allIds;

      const rng = mulberry32(hash32(`${todayISO}|${currentUserId()}`));
      const arr = pool.slice();

      // FisherโYates
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }

      return arr.slice(0, 5);
    }

    async function getHadithOfDay(todayISO) {
      const dailyKey = userKey(`hadith_daily_${todayISO}_v1`);
      const usedKey = userKey("hadith_used_v1");

      const stored = safeJsonParse(localStorage.getItem(dailyKey) || "", null);
      if (stored?.ids && Array.isArray(stored.ids) && stored.ids.length === 5) {
        const bank = await loadHadithBank();
        const map = new Map(bank.map((h) => [h.id, h]));
        const out = stored.ids.map((id) => map.get(id)).filter(Boolean);
        if (out.length === 5) return out;
      }

      const bank = await loadHadithBank();
      const allIds = bank.map((h) => h.id);

      const usedArr = safeJsonParse(localStorage.getItem(usedKey) || "", []);
      const usedSet = new Set(Array.isArray(usedArr) ? usedArr : []);

      const ids = pickDailyHadithIds(todayISO, allIds, usedSet);
      const map = new Map(bank.map((h) => [h.id, h]));
      const hadiths = ids.map((id) => map.get(id)).filter(Boolean);

      localStorage.setItem(dailyKey, JSON.stringify({ ids, savedAt: Date.now() }));

      // Update used
      const nextUsed = new Set(usedSet);
      if (hadiths.length === 5) hadiths.forEach((h) => nextUsed.add(h.id));
      // If we ุงุถุทุฑุฑูุง ูุฑุฌุน ูููุงุฆูุฉ ูููุง (ุจุณุจุจ ููุต ุงููุชุงุญ)ุ ูุนูุฏ ุงูุจุฏุก ูู ุฌุฏูุฏ
      if (allIds.filter((id) => !usedSet.has(id)).length < 5) {
        localStorage.setItem(usedKey, JSON.stringify(hadiths.map((h) => h.id)));
      } else {
        localStorage.setItem(usedKey, JSON.stringify(Array.from(nextUsed)));
      }

      return hadiths.length === 5 ? hadiths : HADITH_CFG.FALLBACK.slice(0, 5);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderHadithUI(todayISO, hadiths) {
      const sub = qs("#hadithModalSub");
      if (sub) {
        sub.textContent = `ูฅ ุฃุญุงุฏูุซ ุซุงุจุชุฉ ููููู โข ${todayISO}`;
      }

      const meta = qs("#hadithMeta");
      if (meta) {
        meta.innerHTML = `
          <span class="tafsir-page-chip">ูุตุงุฏุฑ: ุงูุตุญูุญูู</span>
          <span class="tafsir-page-chip">ูุง ุชุชูุฑุฑ ุญุชู ุชููุฏ ุงููุงุฆูุฉ</span>
        `;
      }

      const list = qs("#hadithList");
      if (!list) return;

      list.innerHTML = hadiths.map((h, i) => {
        const num = formatArabicNumber(i + 1);
        return `
          <div class="tafsir-page">
            <div class="tafsir-page-head">
              <span class="tafsir-page-badge">ุญุฏูุซ ${num}</span>
              <span class="tafsir-page-badge secondary">${escapeHtml(h.book || "โ")}</span>
            </div>
            <div class="quran-text" style="font-size:18px;line-height:2.1">${escapeHtml(h.text)}</div>
          </div>
        `;
      }).join("");
    }

    function setupHadithModal(todayISO, state) {
      const modal = qs("#hadithModal");
      if (!modal) return;

      const openBtn = qs("#openHadithModal");
      const closeBtn = qs("#closeHadithModal");
      const closeBtn2 = qs("#closeHadithModal2");
      const copyBtn = qs("#hadithCopy");
      const doneBtn = qs("#hadithMarkDone");

      async function openModal() {
        modal.classList.add("open");
        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        const list = qs("#hadithList");
        if (list) list.innerHTML = `<div class="tafsir-loader">ุฌุงุฑู ุชุญููู ุฃุญุงุฏูุซ ุงููููโฆ</div>`;

        const hadiths = await getHadithOfDay(todayISO);
        renderHadithUI(todayISO, hadiths);
      }

      function closeModal() {
        modal.classList.remove("open");
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      }

      if (openBtn) openBtn.addEventListener("click", openModal);
      if (closeBtn) closeBtn.addEventListener("click", closeModal);
      if (closeBtn2) closeBtn2.addEventListener("click", closeModal);

      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("open")) closeModal();
      });

      if (copyBtn) {
        copyBtn.addEventListener("click", async () => {
          const hadiths = await getHadithOfDay(todayISO);
          const txt = hadiths.map((h, i) => `${i + 1}) ${h.text} โ (${h.book})`).join("\n\n");
          try {
            await navigator.clipboard.writeText(txt);
            showToast("ุชู ูุณุฎ ุงูุฃุญุงุฏูุซ โ");
          } catch {
            showToast("ุชุนุฐูุฑ ุงููุณุฎ ุชููุงุฆููุง");
          }
        });
      }

      if (doneBtn) {
        doneBtn.addEventListener("click", () => {
          if (!WA3I_CTX.state || !WA3I_CTX.todayISO) return;

          const curISO = WA3I_CTX.todayISO;
          const curState = WA3I_CTX.state;

          curState.tasks.hadith = true;
          setCheckbox("hadith", true);
          updateProgressUI(curState);
          maybeUpdateStreakOnFullCompletion(curISO, curState);
          setDailyState(curISO, curState);
          closeModal();
        });
      }
    }


    // ---------------------------
    // Daily init
    // ---------------------------
    function initDailyFlow() {
      const today = new Date();
      const todayISO = toLocalISODate(today);

      qs("#todayDate").textContent = today.toLocaleDateString("ar", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      });

      const quranPlan = computeDailyQuranPages(today);

      qs("#hizbNumber").textContent =
        `ุตูุญุงุช ${formatArabicNumber(quranPlan.start)}โ${formatArabicNumber(quranPlan.end)}`;

      qs("#hizbLabel").textContent =
        `ุตูุญุงุช ${formatArabicNumber(quranPlan.start)}โ${formatArabicNumber(quranPlan.end)}`;

      qs("#hizbHint").textContent = "ููุณ ุงูุตูุญุงุช ููุฌููุน ุญุณุจ ุชุงุฑูุฎ ุงูููู";

      qs("#challengeTitle").textContent = CONFIG.CHALLENGES[dayOfYear(today) % CONFIG.CHALLENGES.length];
      applyLinks();

      let state = getDailyState(todayISO);
      if (!state) state = defaultDailyState();

      WA3I_CTX.todayISO = todayISO;
      WA3I_CTX.state = state;

      TASK_KEYS.forEach((k) => {
        if (typeof state.tasks?.[k] !== "boolean") state.tasks[k] = false;
        setCheckbox(k, state.tasks[k]);
      });

      qs("#streakCount").textContent = String(getStreak());
      setBreathUI(state);
      updateProgressUI(state);

      qsa('input[type="checkbox"][data-task]').forEach((el) => {
        el.addEventListener("change", () => {
          const key = el.getAttribute("data-task");
          state.tasks[key] = el.checked;

          if (key === "deep_breath" && el.checked === false) {
            state.breathSecondsLeft = CONFIG.BREATH.TOTAL_SECONDS;
            stopBreathTimer(state);
          }

          setBreathUI(state);
          updateProgressUI(state);
          maybeUpdateStreakOnFullCompletion(todayISO, state);
          setDailyState(todayISO, state);
        });
      });

      qs("#breathStart").addEventListener("click", () => startBreathTimer(todayISO, state));
      qs("#breathReset").addEventListener("click", () => resetBreathTimer(todayISO, state));

      qs("#resetToday").addEventListener("click", () => {
        stopBreathTimer(state);
        state = defaultDailyState();
        WA3I_CTX.state = state;

        TASK_KEYS.forEach((k) => setCheckbox(k, false));
        setBreathUI(state);
        updateProgressUI(state);
        setDailyState(todayISO, state);
      });

      document.addEventListener("visibilitychange", () => {
        if (document.hidden && state.breathRunning) {
          stopBreathTimer(state);
          setDailyState(todayISO, state);
        }
      });

      setupQuranModal(quranPlan);
      setupHadithModal(todayISO, state);
    }

    document.addEventListener("DOMContentLoaded", () => {
      try { localStorage.removeItem(USER_STORAGE_KEY); } catch {}

      // Fix: allow Amjad admin login modal to show while the identity gate is open.
      // The gate hides #appRoot (which originally contains the modal), so we move the modal under <body>.
      const adminModal = qs("#adminLoginModal");
      if (adminModal && adminModal.parentElement !== document.body) {
        document.body.appendChild(adminModal);
      }


      decorateMemberCardsWithStreaks();

      initIdentityGate();
    });
</script>
</body>
</html>
